<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
<head>
    <title>Measurements map</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.css"/>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key= AIzaSyCXdo_Op4uqweUGFkXgO_8EA230aLEEhTs&amp;callback=map"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/

        function load() {
            var mapzoomsettings = /*[[${mapSettings}]]*/;
            if (typeof mapzoomsettings == 'undefined' || mapzoomsettings == null || mapzoomsettings[0] == null) {
                var map_zoom = 3;
                var map_center_latitude = 50;
                var map_center_longitude = 20;
            }else{
                var map_zoom = mapzoomsettings[0].mapzoom;
                var map_center_latitude = Number(mapzoomsettings[0].maplatitude);
                var map_center_longitude = Number(mapzoomsettings[0].maplongitude);
            }

            var map = new google.maps.Map(document.getElementById("map"), {
                center: new google.maps.LatLng(map_center_latitude, map_center_longitude),
                zoom: map_zoom,
                mapTypeId: 'roadmap'
            });
            var infoWindow = new google.maps.InfoWindow;
            var accesspointslist = /*[[${accesspointsMap}]]*/;
            for (var i = 0; accesspointslist.length; i++) {
                if (typeof accesspointslist[i].mac !== 'undefined' && accesspointslist[i].mac !== null) {
                    var ap_mac = accesspointslist[i].mac;
                }else{
                    var ap_mac = "-";
                }
                if (typeof accesspointslist[i].measurementscount !== 'undefined' && accesspointslist[i].measurementscount !== null) {
                    var measurement_count = accesspointslist[i].measurementscount;
                }else{
                    var measurement_count = "-";
                }
                if (typeof accesspointslist[i].downloadavg !== 'undefined' && accesspointslist[i].downloadavg !== null) {
                    var measurement_download_rate_avg = accesspointslist[i].downloadavg;
                }else{
                    var measurement_download_rate_avg = "-";
                }
                if (typeof accesspointslist[i].downloadmax !== 'undefined' && accesspointslist[i].downloadmax !== null) {
                    var measurement_download_rate_max = accesspointslist[i].downloadmax;
                }else{
                    var measurement_download_rate_max = "-";
                }
                if (typeof accesspointslist[i].downloadmin !== 'undefined' && accesspointslist[i].downloadmin !== null) {
                    var measurement_download_rate_min = accesspointslist[i].downloadmin;
                }else{
                    var measurement_download_rate_min = "-";
                }
                if (typeof accesspointslist[i].uploadavg !== 'undefined' && accesspointslist[i].uploadavg !== null) {
                    var measurement_upload_rate_avg = accesspointslist[i].uploadavg;
                }else{
                    var measurement_upload_rate_avg = "-";
                }
                if (typeof accesspointslist[i].uploadmax !== 'undefined' && accesspointslist[i].uploadmax !== null) {
                    var measurement_upload_rate_max = accesspointslist[i].uploadmax;
                }else{
                    var measurement_upload_rate_max = "-";
                }
                if (typeof accesspointslist[i].uploadmin !== 'undefined' && accesspointslist[i].uploadmin !== null) {
                    var measurement_upload_rate_min = accesspointslist[i].uploadmin;
                }else{
                    var measurement_upload_rate_min = "-";
                }

                if (typeof accesspointslist[i].pingavg !== 'undefined' && accesspointslist[i].pingavg !== null) {
                    var measurement_local_ping_avg = accesspointslist[i].pingavg;
                }else{
                    var measurement_local_ping_avg = "-";
                }
                if (typeof accesspointslist[i].pingmax !== 'undefined' && accesspointslist[i].pingmax !== null) {
                    var measurement_local_ping_max = accesspointslist[i].pingmax;
                }else{
                    var measurement_local_ping_max = "-";
                }
                if (typeof accesspointslist[i].pingmin !== 'undefined' && accesspointslist[i].pingmin !== null) {
                    var measurement_local_ping_min = accesspointslist[i].pingmin;
                }else{
                    var measurement_local_ping_min = "-";
                }
                if (typeof accesspointslist[i].building !== 'undefined' && accesspointslist[i].building !== null) {
                    var ap_building = accesspointslist[i].building;
                }else{
                    var ap_building = "-";
                }
                if (typeof accesspointslist[i].floor !== 'undefined' && accesspointslist[i].floor !== null) {
                    var ap_floor = accesspointslist[i].floor;
                }else{
                    var ap_floor = "-";
                }

                if (typeof accesspointslist[i].latitude !== 'undefined' && accesspointslist[i].latitude !== null && typeof accesspointslist[i].longitude !== 'undefined' && accesspointslist[i].longitude !== null) {
                    var point = new google.maps.LatLng(
                            parseFloat(accesspointslist[i].latitude),
                            parseFloat(accesspointslist[i].longitude));
                    var html = "<p align=\"left\"><b>Access point MAC (" + ap_mac + ")</b><p/> " +
                            "<p align=\"left\"><b>Info: (</b>Building: <i>" + ap_building + "</i>   -   Floor: <i>" + ap_floor + "</i><b>)</b><p/>" +
                            "<p align=\"left\"><b>Total Measurements: </b>" + measurement_count + "<p/>" +
                            "<p align=\"left\"><b>Download rate: </b>" + measurement_download_rate_avg + " Kbps (avg), " +
                            measurement_download_rate_max + " Kbps (max), " + measurement_download_rate_min + " Kbps (min)<p/>" +
                            "<p align=\"left\"><b>Upload rate: </b>" + measurement_upload_rate_avg + " Kbps (avg), " +
                            measurement_upload_rate_max + " Kbps (max), " + measurement_upload_rate_min + " Kbps (min)<p/>" +
                            "<p align=\"left\"><b>Round Trip Time: </b>" + measurement_local_ping_avg + " ms (avg), " +
                            measurement_local_ping_max + " ms (max), " + measurement_local_ping_min + " ms (min)<p/>";
                    var marker = new google.maps.Marker({
                        map: map,
                        position: point,
                        icon: '../../static/images/mm_20_blue.png'
                    });
                    bindInfoWindow(marker, map, infoWindow, html);
                }
            }
        }

        function bindInfoWindow(marker, map, infoWindow, html) {
            google.maps.event.addListener(marker, 'click', function() {
                infoWindow.setContent(html);
                infoWindow.open(map, marker);
            });
        }

        function doNothing() {}

        /*]]>*/
    </script>
</head>


<body onload="load()">
<div th:replace="fragments/header :: header"></div>

<div class="container" style="padding-top: 10ex; padding-bottom: 10ex;">
    <h3>Measurements Map</h3>

    <!--TODO Add table with statistics-->

    <div class="row">
        <div class="col-md-12" align="center">
            <div class="row">
                <div id="map" style="width:650px;height:400px;background:grey"></div>
            </div>
        </div>
    </div>
    <p></p>
    <div class="row">
        <div class="panel panel-default">
            <div class="panel-heading">
                <span class="pull-left"><h4>Map zoom options</h4></span>
                <span class="pull-right">
                    <a href="#" th:unless="${#lists.isEmpty(mapSettings)}" th:href="@{/secure/editMapSettings}" class="btn btn-success" title="Edit map zoom settings">
                        <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                    </a>
                    <a href="#" th:unless="!${#lists.isEmpty(mapSettings)}" th:href="@{/secure/editMapSettings}" class="btn btn-success" title="Insert map zoom settings">
                        <span class="glyphicon glyphicon-plus-sign" aria-hidden="true"></span>
                    </a>
                </span>
                <div class="clearfix"></div>
            </div>
            <div class="panel-body">
                <div th:unless="${#lists.isEmpty(mapSettings)}">
                    <table class="table table-striped table-bordered table-condensed"
                           style="word-wrap: break-word; table-layout: fixed;">
                        <thead>
                        <td>Zoom Level</td>
                        <td>Center Latitude</td>
                        <td>Center Longitude</td>
                        </thead>
                        <tbody>
                        <tr data-th-each="u : ${mapSettings}">
                            <td data-th-text="${u.mapzoom}"></td>
                            <td data-th-text="${u.maplatitude}"></td>
                            <td data-th-text="${u.maplongitude}"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div th:unless="!${#lists.isEmpty(mapSettings)}" class="alert alert-warning text-center">
                    <strong>Map zoom settings not set</strong>
                </div>
            </div>
        </div>
    </div>
</div>


<div th:replace="fragments/footer :: footer"></div>
</body>


</html>